<!DOCTYPE html>
<html>
<head>
    <title>VTiger Auto Cron Controller</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .status-box { background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d5edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2980b9; }
        .btn.danger { background: #e74c3c; }
        .btn.danger:hover { background: #c0392b; }
        .btn.success { background: #27ae60; }
        .btn.success:hover { background: #229954; }
        .logs { max-height: 300px; overflow-y: auto; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #3498db; }
        .log-success { border-left-color: #27ae60; }
        .log-error { border-left-color: #e74c3c; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #3498db; color: white; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ VTiger Auto Cron Controller</h1>
            <p>H·ªá th·ªëng t·ª± ƒë·ªông h√≥a cron job kh√¥ng c·∫ßn Windows Task Scheduler</p>
        </div>
        
        <div id="status" class="status-box warning">
            <strong>‚è≥ ƒêang kh·ªüi t·∫°o...</strong>
            <p>H·ªá th·ªëng ƒëang ki·ªÉm tra c·∫•u h√¨nh v√† kh·ªüi ƒë·ªông d·ªãch v·ª• t·ª± ƒë·ªông.</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRuns">0</div>
                <div class="stat-label">T·ªïng l·∫ßn ch·∫°y</div>
            </div>
            <div class="stat-card" style="background: #27ae60;">
                <div class="stat-number" id="successRuns">0</div>
                <div class="stat-label">Th√†nh c√¥ng</div>
            </div>
            <div class="stat-card" style="background: #e74c3c;">
                <div class="stat-number" id="failedRuns">0</div>
                <div class="stat-label">Th·∫•t b·∫°i</div>
            </div>
            <div class="stat-card" style="background: #f39c12;">
                <div class="stat-number" id="nextRun">--</div>
                <div class="stat-label">Ch·∫°y ti·∫øp theo</div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn success" onclick="startAutoCron()">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Auto Cron</button>
            <button class="btn danger" onclick="stopAutoCron()">‚èπÔ∏è D·ª´ng Auto Cron</button>
            <button class="btn" onclick="triggerNow()">‚ö° Ch·∫°y ngay</button>
            <button class="btn" onclick="refreshStatus()">üîÑ Refresh</button>
            <button class="btn" onclick="clearLogs()">üóëÔ∏è X√≥a logs</button>
        </div>
        
        <div>
            <h3>üìã Cron Execution Logs</h3>
            <div id="logs" class="logs">
                <div>ƒêang t·∫£i logs...</div>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #ecf0f1; border-radius: 5px;">
            <h4>‚ÑπÔ∏è Th√¥ng tin h·ªá th·ªëng:</h4>
            <ul>
                <li><strong>Auto Trigger:</strong> JavaScript ch·∫°y ng·∫ßm m·ªói 5 ph√∫t</li>
                <li><strong>Service Worker:</strong> Ti·∫øp t·ª•c ch·∫°y khi ƒë√≥ng tab</li>
                <li><strong>Target:</strong> <code>vtigercron.php</code></li>
                <li><strong>ƒêi·ªÅu ki·ªán:</strong> Ch·ªâ ch·∫°y khi c√≥ scheduled workflows</li>
                <li><strong>Browser Support:</strong> Chrome, Firefox, Edge, Safari</li>
            </ul>
        </div>
    </div>

    <script src="js/vtiger-auto-cron.js"></script>
    <script>
        let controller = null;
        let refreshTimer = null;
        
        // Kh·ªüi t·∫°o khi page load
        document.addEventListener('DOMContentLoaded', function() {
            // ƒê·ª£i VtigerAutoCron load xong
            setTimeout(initializeController, 2000);
            
            // Auto refresh m·ªói 30 gi√¢y
            refreshTimer = setInterval(refreshStatus, 30000);
        });
        
        function initializeController() {
            if (window.VtigerAutoCron) {
                controller = window.VtigerAutoCron;
                refreshStatus();
                updateStatus('H·ªá th·ªëng ƒë√£ s·∫µn s√†ng! Auto cron ƒëang ch·∫°y.', 'success');
            } else {
                updateStatus('Kh√¥ng th·ªÉ kh·ªüi t·∫°o VtigerAutoCron. Vui l√≤ng refresh trang.', 'error');
                setTimeout(initializeController, 5000);
            }
        }
        
        function startAutoCron() {
            if (controller) {
                controller.startAutoTrigger();
                updateStatus('Auto cron ƒë√£ ƒë∆∞·ª£c b·∫Øt ƒë·∫ßu.', 'success');
                setTimeout(refreshStatus, 1000);
            }
        }
        
        function stopAutoCron() {
            if (controller) {
                controller.stopAutoTrigger();
                updateStatus('Auto cron ƒë√£ ƒë∆∞·ª£c d·ª´ng.', 'warning');
                setTimeout(refreshStatus, 1000);
            }
        }
        
        async function triggerNow() {
            if (controller) {
                updateStatus('ƒêang ch·∫°y cron job...', 'warning');
                await controller.triggerCron();
                setTimeout(refreshStatus, 2000);
            }
        }
        
        function refreshStatus() {
            if (!controller) return;
            
            const status = controller.showStatus();
            const logs = controller.getLogs();
            
            updateStats(logs);
            updateLogs(logs);
            
            if (status.isAutoRunning) {
                updateStatus('Auto cron ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.', 'success');
            } else {
                updateStatus('Auto cron ƒë√£ d·ª´ng. Click "B·∫Øt ƒë·∫ßu Auto Cron" ƒë·ªÉ kh·ªüi ƒë·ªông.', 'warning');
            }
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status-box ' + type;
            statusEl.innerHTML = '<strong>' + message + '</strong>';
        }
        
        function updateStats(logs) {
            const total = logs.length;
            const success = logs.filter(l => l.status.includes('SUCCESS')).length;
            const failed = total - success;
            
            document.getElementById('totalRuns').textContent = total;
            document.getElementById('successRuns').textContent = success;
            document.getElementById('failedRuns').textContent = failed;
            
            // Next run time (5 ph√∫t t·ª´ l·∫ßn cu·ªëi)
            if (logs.length > 0) {
                const lastRun = new Date(logs[0].timestamp);
                const nextRun = new Date(lastRun.getTime() + 5 * 60 * 1000);
                const now = new Date();
                
                if (nextRun > now) {
                    const minutes = Math.ceil((nextRun - now) / (60 * 1000));
                    document.getElementById('nextRun').textContent = minutes + ' ph√∫t';
                } else {
                    document.getElementById('nextRun').textContent = 'S·∫µn s√†ng';
                }
            }
        }
        
        function updateLogs(logs) {
            const logsEl = document.getElementById('logs');
            
            if (logs.length === 0) {
                logsEl.innerHTML = '<div>Ch∆∞a c√≥ logs n√†o.</div>';
                return;
            }
            
            const logHtml = logs.slice(0, 20).map(log => {
                const time = new Date(log.timestamp).toLocaleString();
                const statusClass = log.status.includes('SUCCESS') ? 'log-success' : 'log-error';
                
                return `<div class="log-entry ${statusClass}">
                    <strong>${time}</strong> [${log.trigger}] ${log.status} 
                    <span style="opacity: 0.7">(${log.duration}ms)</span>
                </div>`;
            }).join('');
            
            logsEl.innerHTML = logHtml;
        }
        
        function clearLogs() {
            if (controller && confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ logs?')) {
                controller.clearLogs();
                refreshStatus();
            }
        }
        
        // Cleanup khi r·ªùi kh·ªèi trang
        window.addEventListener('beforeunload', function() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
        });
    </script>
</body>
</html>